#!/bin/bash

#   deploy-branchster  -  Make the ipa, manifest, and web page for Branchster.
#
#   E.B. Smith  February 2017.

set -eu -o pipefail
scriptname="$(basename "$0")"
scriptpath="$( cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$scriptpath"/..


# baseurl="https://shimmering.blue/ios/branchster"
baseurl="http://cdn.branch.io/ios/branchster"
stagingpath=./Staging-Branchster
deployapp=BranchMonsterFactory


if [[ ${CLICOLOR:0} == 1 && -t 1 ]]; then
    textBold="\e[1m"
    textBlue="\e[94m"
    textDarkBlue="\e[1m\e[34m"
    textYellow="\e[93m"
    textRed="\e[31m"
    textNormal="\e[0m"
    textDim="\e[2m"
else
    textBold=""
    textBlue=""
    textDarkBlue=""
    textYellow=""
    textRed=""
    textNormal=""
    textDim=""
fi

function showErrorOnExit() {
    printf "${textRed}"
    printf " -------------------------------------------------------------------\n"
    printf "                            Deploy failed.\n"
    printf " -------------------------------------------------------------------"
    printf "${textNormal}\n"
}
trap "showErrorOnExit" EXIT


printf "${textBlue}>>> Deploying: `pwd`${textNormal}\n"

./Tools/ipa-make-archive

printf "${textBlue}>>> Making manifest...${textNormal}\n"
./Tools/ipa-make-manifest -u "${baseurl}" "$stagingpath"/"$deployapp".ipa > "$stagingpath"/"$deployapp".plist

printf "${textBlue}>>> Making webpage...${textNormal}\n"
./Tools/ipa-make-webpage  -u "${baseurl}" "$stagingpath"/"$deployapp".ipa > "$stagingpath"/index.html

printf "${textBlue}>>> Uploading...${textNormal}\n"
./Tools/deploy-upload-aws

trap - EXIT
printf "${textBlue}"
printf ">>> $deployapp deployed.${textNormal}\n"
